# Bing Web検索クライアントサーバへの研究室クラスターへのデプロイ

## 前提

- [Bing Web検索クライアントサーバ](1-install.md)
  - Azureの`SUBSCRIPTION_KEY`と`ENDPOINT`
- Docker Hubアカウント
- 研究室Jupyter Notebook
  - `hideojoho/jupyter-kubectl`イメージ

## 手順

- クライアントサーバアプリの作成
- Dockerイメージの作成とテスト
- Docker Hubへのアップロード
- k8s設定ファイルの作成と実行
- [Jupyter Notebookからのアクセス](../../k8s/ipynb/bingsearch.ipynb)

## フォルダ構成

```
k8s-bingsearch/
  ├── Dockerfile
  ├── README.md
  ├── app/
  │    └── app.py
  └── requirements.txt
```

## クライアントサーバアプリの作成

- `app.py`
  - [ステップ１で作成したもの](https://github.com/hideojoho/kb/blob/ja/dev/searchengine/bing/1-install.md#api%E3%82%AF%E3%83%A9%E3%82%A4%E3%82%A2%E3%83%B3%E3%83%88%E3%82%B5%E3%83%BC%E3%83%90%E3%81%AE%E6%A7%8B%E7%AF%89)と同じ
  - 違いは`AZURE_SUBSCRIPTION_KEY`と`AZURE_ENDPOINT`を環境変数から読み込んでいる部分

```
# Import required modules.
import os
from azure.cognitiveservices.search.websearch import WebSearchClient
from azure.cognitiveservices.search.websearch.models import SafeSearch
from msrest.authentication import CognitiveServicesCredentials
from flask import *

app = Flask(__name__)

# Subscription key and endpoint must be set by the environmental variables
KEY = os.environ['AZURE_SUBSCRIPTION_KEY']
EP = os.environ['AZURE_ENDPOINT']

# Instantiate the client and replace with your endpoint.
client = WebSearchClient(endpoint=EP, credentials=CognitiveServicesCredentials(KEY))

@app.route("/", methods=['GET'])
def index():
    # q parameter is not given
    if 'q' not in request.args:
        return { "status": "Ready" }
    # Empty query is given
    q = request.args.get('q', default=None, type=str)
    if not q:
        return { "response": None }
    # Query is given
    response = []
    web_data = client.web.search(query=q)
    if hasattr(web_data.web_pages, 'value'):
        response = []
        for i in range(len(web_data.web_pages.value)):
            page = {
                "title": web_data.web_pages.value[i].name,
                "url": web_data.web_pages.value[i].url,
                "snippet": web_data.web_pages.value[i].snippet
            }
            response.append(page)
        return {
            "response": response
        }
    else:
      return { "response": None }

if __name__ == "__main__":
    app.run(debug=True, host='0.0.0.0')
```

### Dockerイメージの作成とテスト

- `Dockerfile`

```
FROM tiangolo/uvicorn-gunicorn-fastapi:python3.8

RUN mkdir /code
WORKDIR /code
ADD requirements.txt /code/
RUN pip install -U pip --no-cache-dir
RUN pip install -r requirements.txt --no-cache-dir
ADD ./app /code/

EXPOSE 5000

CMD ["python", "app.py"]
```

- イメージ作成

```
$ docker build -t YOUR-DOCKERHUB-USERNAME/k8s-bingsearch .
```

- テスト

```
$ docker run -d -it --rm --name bing -e AZURE_SUBSCRIPTION_KEY="YOUR-AZURE_SUBSCRIPTION_KEY" -e AZURE_ENDPOINT="YOUR-AZURE_ENDPOINT" YOUR-DOCKERHUB-USERNAME/k8s-bingsearch
$ curl -s "http://bing:5000/?q=bing"
```

### Docker Hubへのアップロード

- アップロード

```
$ docker push YOUR-DOCKERHUB-USERNAME/k8s-bingsearch
```

###  k8s設定ファイルの作成と実行

- 研究室クラスターからJupyter Notebookを起動（イメージ：`hideojoho/jupyter-kubectl`）
- 設定ファイル`my-bingsearch.yaml`の新規作成

```
apiVersion: apps/v1 # for versions before 1.9.0 use apps/v1beta2
kind: Deployment
metadata:
  name: bingsearch
spec:
  selector:
    matchLabels:
      run: bingsearch
      app: bingsearch
  template:
    metadata:
      labels:
        run: bingsearch
        app: bingsearch
    spec:
      containers:
      - name: bingsearch
        image: YOUR-DOCKERHUB-USERNAME/k8s-bingsearch // Change here or use 'hideojoho/k8s-bingsearch'
        ports:
        - containerPort: 5000
        env:
        - name: AZURE_SUBSCRIPTION_KEY
          value: "YOUR-AZURE_SUBSCRIPTION_KEY" // Change here
        - name: AZURE_ENDPOINT
          value: "YOUR-AZURE_ENDPOINT" // Change here
---
apiVersion: v1
kind: Service
metadata:
  name: bingsearch
  labels:
    run: bingsearch
spec:
  ports:
  - port: 5000
    targetPort: 5000
    protocol: TCP
  selector:
    run: bingsearch
```
